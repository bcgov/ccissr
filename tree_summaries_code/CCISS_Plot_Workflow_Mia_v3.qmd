---
title: "CCISS_Plot_Workflow"
format: html
editor: visual
---

# CCISS Plots!

## Load Necessary Data

We'll use the high resolution dem for the lower mainland. It's small enough that we can run the analysis quickly.

```{r}
library(terra)
library(ranger)
library(ccissr)
library(data.table)
library(RColorBrewer)
library(bcmaps)
library(sf)
library(climr)
library(here)
library(duckdb)
library(DBI)
library(ggplot2)


#BGCmodel <- readRDS("../Common_Files/BGCmodel_WNA_V2.1.rds")
BGCmodel <- readRDS(here("tree_summaries_code", "BGCmodel_WNA_V2.1.rds")) #Only stored here locally because too large to push

dem2 <- rast("//objectstore2.nrs.bcgov/ffec/DEM/dem_BC2kmGrid.tif") 

# bumobnd <- st_read("bdy.BuMo.shp")
# dem <- cded_terra(aoi = bumobnd, check_tiles = FALSE)
# dem <- mask(dem, vect(bumobnd))
# dem2 <- aggregate(dem, fact = 45)

#dem2 <- rast("dem_BC2kmGrid.tif")
dem_table <- climr::dem_to_table(dem2)
```

## Setup parameters for model

```{r}
gcms_cciss <- c("ACCESS-ESM1-5", "CNRM-ESM2-1", "EC-Earth3", "GFDL-ESM4",
                "GISS-E2-1-G", "MIROC6", "MPI-ESM1-2-HR", "MRI-ESM2-0")

vars_needed <- c("CMD_sm", "DDsub0_sp", "DD5_sp", "Eref_sm", "Eref_sp", "EXT", 
                 "MWMT", "NFFD_sm", "NFFD_sp", "PAS_an", "PAS_sp", "SHM", "Tave_sm", 
                 "Tave_sp", "Tmax_sm", "Tmax_sp", "Tmin_an", "Tmin_at", "Tmin_sm", 
                 "Tmin_sp", "Tmin_wt","CMI_an", "PPT_05","PPT_06","PPT_07","PPT_08",
                 "PPT_09","PPT_at","PPT_wt","CMD_07","CMD_an"
)
```

## Create Mapped BGC Raster

```{r}
#bgcs <- vect("../Common_Files/BEC13Draft_Simplified.gpkg")
bgcs <- vect(here("tree_summaries_code", "BEC13Draft_Simplified.gpkg"))
bgc_template <- make_bgc_template(dem2, bgcs)

plot(bgc_template$bgc_rast)
```

## Setup database

```{r}
#con <- dbCon_cciss("../cciss.duckdb", threads = 8) #old
con <- dbCon_cciss("../bc_2km.duckdb", threads = 8)
dbPopulate(con, bgc_template)
```

## Run Raw BGC Predictions

Create raw (not summarised) predictions - one for each gcm/scenario/run/timeperiod. We do this by simply passing `summarise = FALSE`.

```{r}

predict_bgc(con, dem_table, BGCmodel, vars_needed, gcms_cciss, periods_use = c("2021_2040", "2041_2060", "2061_2080", "2081_2100"), max_runs_use = 4L)

```

## Calculate BGC Persistance/Expansion

```{r}
bgc_perexp <- bgc_persist_expand(con, by_zone = TRUE)
```

## BGC Bubbleplot

```{r}
bgc_bubbleplot(bgc_perexp, period = "2041_2060", scenario = "ssp245")
bgc_bubbleplot(bgc_perexp, period = "2081_2100", scenario = "ssp370")
```

## Calculate Species Persistance and Expansion

```{r}


DBI::dbExecute(con, "PRAGMA max_temp_directory_size='20GiB'") #Mia added 

perexp <- spp_persist_expand(con, spp_list = c("Pl","Py","Lw","At","Sx","Cw","Fd"), fractional = TRUE)
#perexp <- spp_persist_expand(con, spp_list = c("Cw"), fractional = TRUE) # try a single species
```

## Species Bubbleplot

```{r}
spp_bubbleplot(perexp, period_sel = "2041_2060", scenario = "ssp370", edatope = "C4")

spp_bubbleplot(perexp, period_sel = "2081_2100", scenario = "ssp245", species = "Cw", edatope = c("B2", "C4", "D6"), by = "edatope")
#Cw_ssp245_bub <- spp_bubbleplot(perexp, period_sel = "2081_2100", scenario = "ssp245", species = "Cw", edatope = c("B2", "C4", "D6"), by = "edatope"); Cw_ssp245_bub 
#why can't I save this as an object?
```

Save these plots to a subfolder, so they can be called into the dashboard qmd scripts:

```{r}
#currently not working
#ggsave("Cw_ssp245_bub.png", plot = Cw_ssp245_bub, path = here("tree_summaries_code", "Figures"),width = 6, height = 4, dpi = 300)
```

# Suitable Area

## Calculate Relative Feasible Area

```{r}
#sa <- spp_suit_area(con, spp_list = c("Cw","Pl","Sx","Lw","Fd"))
sa <- spp_suit_area(con, spp_list = c("Cw")) #try only 1 spp at a time
```

## Species Spaghetti Plot with indiv. Runs

```{r}
Cw_spag <- spp_spaghettiplot(sa, species = "Cw", use_MAT = FALSE); Cw_spag

Cw_spag2 <- spp_spaghettiplot(sa, species = "Cw", use_MAT = TRUE); Cw_spag2

#New MAT plot interpretation: As the MAT increases, the proportion of the historic suitable area overall increases.
```

Save these plots to a subfolder, so they can be called into the dashboard qmd scripts:

```{r}
ggsave("Cw_spag.png", plot = Cw_spag, path = here("tree_summaries_code", "Figures"),width = 8, height = 4, dpi = 300)

ggsave("Cw_spag2.png", plot = Cw_spag2, path = here("tree_summaries_code", "Figures"),width = 8, height = 4, dpi = 300)
```

# Alluvial Plot

Unlike the previous plots, for the alluvial/stacked bar plot, we need the cciss projections to be summarised instead of individual runs. We'll summarise directly on the database.

```{r}

summarise_preds(con)
```

Great! Now we have that we can create the siteseries and suitability predictions. For the alluvial plots, you can only plot one species and one edatope at a time, but we'll run a bunch so we can make lots of plots quickly.

```{r}
siteseries_preds(con)
spp <- c("Cw","Fd","Pl","Sx")
cciss_suitability(con, species = spp)
```

And now, we can finally create the plot. The basic input parameters are just species and edatope, and then there are a couple of parameters than can be change - namely, whether to use fractional suitability, and whether to group by subzone or zone.

```{r}
Cw_B2_alluv <- plot_spparea(con, spp = "Cw", edatope = "B2", fractional = TRUE); Cw_B2_alluv
Cw_C4_alluv <- plot_spparea(con, spp = "Cw", edatope = "C4", fractional = TRUE); Cw_C4_alluv
Cw_D6_alluv <- plot_spparea(con, spp = "Cw", edatope = "D6", fractional = TRUE); Cw_D6_alluv

# Things I'd like to tweak:
#   1) Maybe: Show only the legend for BGC colors that the species is actually present in. It's showing all of them always now, right? 
#   2) Make the x axis labels the full time period. 2021-2040, etc
```

Save these plots to a subfolder, so they can be called into the dashboard qmd scripts:

```{r}
ggsave("Cw_B2_alluv.png", plot = Cw_B2_alluv, path = here("tree_summaries_code", "Figures"),width = 6, height = 4, dpi = 300)

ggsave("Cw_C4_alluv.png", plot = Cw_C4_alluv, path = here("tree_summaries_code", "Figures"),width = 6, height = 4, dpi = 300)

ggsave("Cw_D6_alluv.png", plot = Cw_D6_alluv, path = here("tree_summaries_code", "Figures"),width = 6, height = 4, dpi = 300)

```

# 2 Panel Map Plot

Recreation of Colin's 2 panel plot. Note that this currently only works using an Albers grid.

```{r}
bc_ol <- vect(here("data-raw", "data_tables", "bc_outline.gpkg"))

#This isn't working now, for some reason
plot_2panel(con, spp = "Cw", edatope = "C4", period = "2081_2100", bgc_template = bgc_template, outline = bc_ol, save_png = TRUE) #these get saved into the tree_summaries_code > Mia folder, where this .qmd is located. :) So I will manually move them into the Figures folder for now.

plot_2panel(con, spp = "Cw", edatope = "B2", period = "2081_2100", bgc_template = bgc_template, outline = bc_ol, save_png = TRUE)

plot_2panel(con, spp = "Cw", edatope = "D6", period = "2081_2100", bgc_template = bgc_template, outline = bc_ol, save_png = TRUE)
```

